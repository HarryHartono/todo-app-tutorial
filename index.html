<!DOCTYPE html>
<html>
    <head>
        <title>My Todo App</title>
        <link rel="stylesheet" href="style.css">
    </head>
    <body>

        <header>
            <div>Hello!!!</div>
        </header>
        
        <main class="main-body">
            <div class="add-new-task">
                <input id="todo-title" type="text" placeholder="Add new task!">
                <input id="date-picker" type="date">
                <button class="add-todo-button" onclick="addToDo()">Add Todo</button>
            </div>
            <div id="todo-list"></div>
        </main>


        <script>
            let todo1 = 'Get Groceries';
            let todo2 = 'Wash Car';
            let todo3 = 'Make Dinner';

            // Model Section
            // If localstorage has a todos array, then use it
            // otherwise use the default array

            let todos;

            //Retrieve from localstorange
            const savedTodos = JSON.parse(localStorage.getItem('todos'));

            // check if it's an array
            if (Array.isArray(savedTodos)) {
                todos = savedTodos;
            } else {
                todos = [{
                    title: 'Get groceries',
                    dueDate: '2021-10-04',
                    id: 'id1'
                }, {
                    title: 'Wash car',
                    dueDate: '2021-02-03',
                    id: 'id2'
                }, {
                    title: 'Make dinner',
                    dueDate: '2021-03-04',
                    id: 'id3'
                }];

            }

            
            // Creates a todo
            const createTodo = (title, dueDate) => {
                const id = '' + new Date().getTime();

                todos.push({
                    title: title,
                    dueDate: dueDate,
                    id: id
                });

                saveTodos();
            };

            //Deletes a todo
            const removeTodo = idToDelete => {
                todos = todos.filter(function (todo) {
                    // if the id this todo matches idToDelete, return flase
                    //for anything else, return true
                    if (todo.id === idToDelete) {
                        return false;
                    } else {
                        return true;
                    }
                });

                saveTodos();
            };

            //toggle todo  
            const toggleTodo = (todoId, checked) => {
                todos.forEach(function (todo) {
                    if (todo.id === todoId) {
                        todo.isDone = checked;
                    }
                });

                saveTodos()
            };

            // edit todo
            const editTheTodo = todoId => {
                todos.forEach(function (todo) {
                    if (todo.id === todoId) {
                        todo.isEditing = true;
                    };
                });

                saveTodos();
            };

            // update todo
            const updateTheTodo = (todoId, newTitle, newDueDate) => {
                todos.forEach(function (todo) {
                    if (todo.id === todoId) {
                        todo.isEditing = false;
                        todo.title = newTitle;
                        todo.dueDate = newDueDate;
                    };
                });

                saveTodos();
            };

            const cancelTheUpdate = todoId => {
                todos.forEach(function (todo) {
                    if (todo.id + 'cancel' === todoId) {
                        todo.isEditing = false;
                    };
                });

                saveTodos();
            };

            const saveTodos = () => {
                localStorage.setItem('todos', JSON.stringify(todos));
            }

            // Control Section
            const addToDo = () => {
                const textbox = document.getElementById('todo-title');
                const title = textbox.value;

                const datePicker = document.getElementById('date-picker');
                const dueDate = datePicker.value;

                createTodo(title, dueDate);
                render();
            };

            const checkTodo = event => {
                const createInput = event.target;

                const todoId = createInput.dataset.todoId;
                const checked = createInput.checked;

                toggleTodo(todoId, checked);
                render();
            };

            const editTodo = event => {
                const editButtonclicked = event.target;

                const todoId = editButtonclicked.id;

                editTheTodo(todoId);
                render();
            };

            const updateTodo = event => {
                const updateButtonclicked = event.target;

                const todoId = updateButtonclicked.id;
                const textbox = document.getElementById(todoId + 'text');
                const newTitle = textbox.value;
                const datePicker = document.getElementById(todoId + 'date');
                const newDueDate = datePicker.value;

                updateTheTodo(todoId, newTitle, newDueDate);
                render();
            };

            const cancelUpdate = event => {
                const cancelButton = event.target;

                const todoId = cancelButton.id;

                cancelTheUpdate(todoId);
                render();
            };

            const onDelete = todoToDelete => {
                return () => {
                    removeTodo(todoToDelete.id);
                    render();
                }
            }

            // View Section
            const render = () => {
                // reset our list
                document.getElementById('todo-list').innerHTML = '';

                todos.forEach(function (todo) {
                    if (todo.isEditing === true) {
                        const element = document.createElement('div');
                        
                        const editTodo = document.createElement('input');
                        editTodo.type = 'text';
                        editTodo.id = todo.id + 'text';
                        element.appendChild(editTodo);

                        const editDate = document.createElement('input');
                        editDate.type = 'date';
                        editDate.id = todo.id + 'date';
                        element.appendChild(editDate);

                        const updateButton = document.createElement('button');
                        updateButton.innerText = 'Update';
                        updateButton.style = 'margin-left: 12px;';
                        updateButton.onclick = updateTodo;
                        updateButton.id = todo.id;
                        element.appendChild(updateButton);

                        const cancelButton = document.createElement('button');
                        cancelButton.innerText = 'Cancel';
                        cancelButton.style = 'margin-left: 12px;';
                        cancelButton.onclick = cancelUpdate;
                        cancelButton.id = todo.id + 'cancel';
                        element.appendChild(cancelButton);

                        const todoList = document.getElementById('todo-list');
                        todoList.appendChild(element);

                    } else {
                        const element = document.createElement('div');

                        const createInput = document.createElement('input');
                        createInput.type = 'checkbox';
                        createInput.style = 'margin-right: 16px; ';
                        createInput.onchange = checkTodo;
                        createInput.dataset.todoId = todo.id;
                        if (todo.isDone === true) {
                            createInput.checked = true;
                        } else {
                            createInput.checked = false;
                        };
                        element.prepend(createInput);

                        const elementTitle = document.createElement('div');
                        elementTitle.innerText = todo.title;
                        elementTitle.style = 'flex: 1'
                        element.appendChild(elementTitle);

                        const elementDueDate = document.createElement('div');
                        elementDueDate.innerText = todo.dueDate;
                        element.appendChild(elementDueDate);

                       
                        element.style = 'display: flex; column-gap: 16px; ';

                        const editButton = document.createElement('button');
                        editButton.innerText = 'Edit';
                        editButton.style = '';
                        editButton.onclick = editTodo;
                        editButton.id = todo.id;
                        element.appendChild(editButton);

                        const deleteButton = document.createElement('button');
                        deleteButton.innerText = 'Delete';
                        deleteButton.style = 'background-color: white;';
                        deleteButton.onclick = onDelete(todo);
                        element.appendChild(deleteButton);

                        const todoList = document.getElementById('todo-list');
                        todoList.appendChild(element);
                    };
                });
            };
            
            render();
        </script>
    </body>
</html>
